<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>똑똑!! 가족 게시판</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
@font-face {
    font-family: 'NexonLv2Gothic';
    src: url('NexonLv2Gothic_2.ttf') format('truetype');
}
:root{--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--brand:#6366f1;--ok:#16a34a;--bad:#dc2626;--wait:#d97706;}
*{box-sizing:border-box}
html, body { overscroll-behavior-y: none; }
body, button, input, textarea {margin:0; font-family:'NexonLv2Gothic', sans-serif; background:var(--bg);}
header{padding:20px 16px;text-align:center;background:#fff;border-bottom:1px solid var(--line);}
header h1 {margin:0; font-size:24px; font-weight:700; cursor: pointer; display: inline-block;}
header p {margin:8px 0 0; font-size:16.8px; color:#666; line-height: 1.4;}

/* 신청 화면 디자인 */
.landing-header { padding: 40px 20px; text-align: center; background: #fff; }
.landing-header h2 { font-size: 18px; color: var(--brand); margin-bottom: 10px; }
.landing-header h1 { font-size: 28px; font-weight: 800; color: #111; }
.form-card { max-width: 400px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
.form-group small { color: #888; font-size: 12px; }

main{max-width:1100px;margin:auto;padding:16px;}
body.full-view main { max-width: 100%; padding: 0; }
body.full-view header { border-bottom: none; }
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;}

button, .sms-btn{display:block; width:100%; padding:9px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin:6px 0; text-align:center; text-decoration:none; font-size:16px; font-family: inherit;}
button.gray, .sms-btn.gray{background:#e5e7eb;color:#111}
button.green{background:var(--ok)}
button.red{background:var(--bad)}
button.fit {width: auto; min-width: 80px; display: inline-block; margin: 0 8px 0 0; padding: 9px 20px;}
.btn-parent-input { width: auto !important; padding: 10px 30px !important; }

input, textarea {width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);margin-top:6px;line-height:1.4;font-size: 16px; color: #333; background: transparent;}
input:disabled, textarea:disabled { background: transparent; color: #333; border-color: #eee; }

.table-wrapper {max-height: 540px;overflow-y: auto;border: 1px solid var(--line);border-radius: 8px;}
table{width:100%; border-collapse:collapse; table-layout: fixed;}
th,td{padding:12px;border-bottom:1px solid var(--line);text-align:center;vertical-align:middle;}
.badge{padding:6px 10px;border-radius:6px;color:#fff;font-size:13px;font-weight:700; white-space: nowrap;}
.ok{background:var(--ok)}.no{background:var(--bad)}.wait{background:var(--wait)}

/* 관리자 문구 숨김 처리 */
.admin-trigger { color: #f1f1f1; font-size: 10px; text-align: center; margin-top: 50px; cursor: default; user-select: none; }

.cal-wrapper { background: #fff; min-height: calc(100vh - 50px); font-family: 'NexonLv2Gothic', sans-serif; transition: opacity 0.3s ease-in-out; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--line); gap: 1px; width: 100%; }
.cal-day { background: #fff; min-height: 120px; padding: 4px; font-size: 12px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
.cal-event-item { color: #000; background-color: #eef2ff; padding: 2px 4px; border-radius: 4px; font-size: 11px; }
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index: 1000;}
.modal .card{width:min(480px,100%); max-height: 85vh; overflow-y: auto;}
.btn-row {display: flex; gap: 10px; margin-top: 20px; justify-content: center;}
.btn-row button, .btn-row .sms-btn {flex: 1; margin: 0;}
</style>
</head>
<body>

<div id="app">로딩 중...</div>

<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// URL에서 공간 ID 추출
const urlParams = new URLSearchParams(window.location.search);
const SPACE_ID = urlParams.get('id');
const ADMIN_PW = "jkd89367102!";

let route = { page: "list", id: null, date: null };
let allData = [];
let calendarData = {};
let currentCalDate = new Date();
let tempParentInput = { momC: "", dadC: "" };
let spaceConfig = null; // 현재 공간의 설정값

// 초기 로직 제어
async function init() {
    if (!SPACE_ID) {
        renderLanding(); // 공간 ID가 없으면 신청 화면
    } else {
        // 공간 정보 가져오기
        const snap = await db.ref(`spaces/${SPACE_ID}`).get();
        if (!snap.exists()) {
            alert("존재하지 않거나 아직 승인되지 않은 공간입니다.");
            location.href = location.pathname;
            return;
        }
        spaceConfig = snap.val();
        
        // 자동 로그인 체크
        const savedPw = localStorage.getItem(`auth_${SPACE_ID}`);
        if (savedPw === spaceConfig.spacePw) {
            startBoard();
        } else {
            openSpaceAuth();
        }
    }
}

// 1. 신청 화면 렌더링
function renderLanding() {
    document.getElementById('app').innerHTML = `
        <div class="landing-header">
            <h2>아이의 생각하는 힘을 키우는 우리 가족만의 이야기 공간</h2>
            <h1>똑똑!! 가족 게시판</h1>
        </div>
        <div class="form-card">
            <div class="form-group">
                <label>공간 아이디</label>
                <input id="reg_id" placeholder="공간 url 생성 아이디 (영문/숫자)">
            </div>
            <div class="form-group">
                <label>공간 비밀번호</label>
                <input id="reg_spacePw" type="password" placeholder="최초 사이트 접속 비밀번호">
            </div>
            <div class="form-group">
                <label>부모 비밀번호</label>
                <input id="reg_parentPw" type="password" placeholder="찬성/반대, 글 삭제 비밀번호">
            </div>
            <div class="form-group">
                <label>등록 정보 수신 휴대폰</label>
                <input id="reg_phone" placeholder="휴대폰 번호를 입력해주세요">
            </div>
            <button onclick="requestSpace()">공간 만들기</button>
        </div>
        <div class="admin-trigger" onclick="adminLogin()">시스템 관리자</div>
    `;
}

// 공간 신청 함수
function requestSpace() {
    const id = document.getElementById('reg_id').value.trim();
    const spacePw = document.getElementById('reg_spacePw').value.trim();
    const parentPw = document.getElementById('reg_parentPw').value.trim();
    const phone = document.getElementById('reg_phone').value.trim();

    if(!id || !spacePw || !parentPw || !phone) return alert("모든 항목을 입력해주세요.");

    db.ref(`requests/${id}`).set({
        id, spacePw, parentPw, phone, status: "신청", time: new Date().toLocaleString()
    }).then(() => {
        alert("공간 생성이 신청되었습니다. 관리자 승인 후 사용 가능합니다.");
        location.reload();
    });
}

// 2. 관리자 시스템
function adminLogin() {
    const pw = prompt("관리자 비밀번호를 입력하세요.");
    if (pw === ADMIN_PW) {
        renderAdmin();
    } else if(pw !== null) {
        alert("비밀번호가 틀렸습니다.");
    }
}

function renderAdmin() {
    db.ref('requests').on('value', (snap) => {
        const data = snap.val() || {};
        const list = Object.values(data);
        document.getElementById('app').innerHTML = `
            <header><h1>시스템 관리자 전용</h1></header>
            <main>
                <div class="card">
                    <b>가족 공간 신청 현황</b>
                    <div class="table-wrapper" style="margin-top:10px;">
                        <table>
                            <thead><tr><th>ID</th><th>신청일</th><th>상태</th></tr></thead>
                            <tbody>
                                ${list.map(req => `
                                    <tr onclick="viewRequest('${req.id}')" style="cursor:pointer">
                                        <td>${req.id}</td>
                                        <td>${req.time.split(' ')[0]}</td>
                                        <td><span class="badge ${req.status === '운영' ? 'ok' : 'wait'}">${req.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <button class="gray" onclick="location.reload()">로그아웃</button>
            </main>
        `;
    });
}

function viewRequest(id) {
    db.ref(`requests/${id}`).once('value', (snap) => {
        const r = snap.val();
        const m = document.getElementById("pwModal");
        m.style.display = "flex";
        const myUrl = `${window.location.origin}${window.location.pathname}?id=${r.id}`;
        m.innerHTML = `
            <div class="card">
                <b>신청 상세 정보</b><br><br>
                아이디: ${r.id}<br>공간PW: ${r.spacePw}<br>부모PW: ${r.parentPw}<br>연락처: ${r.phone}<br>
                <div class="btn-row">
                    <button onclick="approveSpace('${r.id}')">관리자 승인</button>
                    <button class="gray" onclick="document.getElementById('pwModal').style.display='none'">닫기</button>
                </div>
            </div>`;
    });
}

function approveSpace(id) {
    db.ref(`requests/${id}`).once('value', (snap) => {
        const r = snap.val();
        const myUrl = `${window.location.origin}${window.location.pathname}?id=${r.id}`;
        const msg = `[똑똑! 가족게시판] 공간 승인 완료\n\nURL: ${myUrl}\n공간PW: ${r.spacePw}\n부모PW: ${r.parentPw}`;
        
        db.ref(`spaces/${id}`).set({...r, status: "운영"}).then(() => {
            db.ref(`requests/${id}/status`).set("운영");
            alert("승인되었습니다. 문자 전송 창으로 연결합니다.");
            window.location.href = getSmsUrlAdmin(r.phone, msg);
        });
    });
}

function getSmsUrlAdmin(phone, text) {
    const ua = navigator.userAgent.toLowerCase();
    return /iphone|ipad|ipod/.test(ua) ? `sms:${phone}&body=${encodeURIComponent(text)}` : `sms:${phone}?body=${encodeURIComponent(text)}`;
}

// 3. 게시판 로직 시작 (비밀번호 인증)
function openSpaceAuth() {
    document.getElementById('app').innerHTML = `
        <div class="form-card" style="margin-top:100px; text-align:center;">
            <h2>우리 가족 공간 접속</h2>
            <p style="font-size:14px; color:#666;">공간 비밀번호를 입력해주세요.</p>
            <input id="space_auth_pw" type="password" style="text-align:center; margin:20px 0;">
            <button onclick="checkSpaceAuth()">접속하기</button>
        </div>
    `;
}

function checkSpaceAuth() {
    const input = document.getElementById('space_auth_pw').value;
    if (input === spaceConfig.spacePw) {
        localStorage.setItem(`auth_${SPACE_ID}`, input);
        startBoard();
    } else {
        alert("비밀번호가 올바르지 않습니다.");
    }
}

// 기존 게시판 기능 시작
function startBoard() {
    db.ref(`data/${SPACE_ID}/approvals`).on("value", (snapshot) => {
      const val = snapshot.val();
      allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
      if(route.page === "list") render();
    });

    db.ref(`data/${SPACE_ID}/calendar`).on("value", (snapshot) => {
      calendarData = snapshot.val() || {};
      if(route.page === 'calendar' || route.page === 'calDetail') render();
    });
    render();
}

/* --- 게시판 렌더링 및 기능 (기존 코드 유지) --- */
function render() {
    const app = document.getElementById("app");
    if(route.page === "list") {
        app.innerHTML = `
            <header><h1 onclick="goHome()">똑똑!! 가족 게시판</h1><p>엄마와 아빠는 언제나 너의 멋진 계획을 응원해!</p></header>
            <main>
                <div class="top-actions">
                    <button class="btn-submit" onclick="navigate({page:'new'})">의견 올리기</button>
                    <button class="btn-stats" onclick="openStats()">통계</button>
                    <button class="btn-cal" onclick="navigate({page:'calendar'})">캘린더</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <colgroup><col style="width: 45px;"><col><col style="width: 75px;"></colgroup>
                        <thead><tr><th>No</th><th>제목 / 상신시간</th><th>상태</th></tr></thead>
                        <tbody>
                            ${allData.map((r,i)=>`<tr class="approval-row" onclick="navigate({page:'view', id:'${r.id}'})">
                                <td>${allData.length - i}</td>
                                <td style="text-align:left"><div>${esc(r.title)}</div><small style="color:#888;">${r.time}</small></td>
                                <td>${badge(getStatus(r))}</td>
                            </tr>`).join("")}
                        </tbody>
                    </table>
                </div>
            </main>
        `;
    } 
    else if(route.page === "new"){
        app.innerHTML = `
            <header><h1 onclick="goHome()">똑똑!! 가족 게시판</h1></header>
            <main><div class="card">
                <label>제목</label><input id="t">
                <label>의견</label><textarea id="p" class="purpose-box"></textarea>
                <label>계획</label><textarea id="pl" class="plan-box"></textarea>
                <label>비용(원)</label><input id="c" oninput="this.value=formatComma(this.value)">
                <div class="btn-row"><button onclick="confirmSubmit()">의견 올리기</button><button class="gray" onclick="navigate({page:'list'})">취소</button></div>
            </div></main>`;
    }
    else if(route.page === "view"){
        const r = allData.find(x => String(x.id) === String(route.id));
        app.innerHTML = `
            <header><h1 onclick="goHome()">똑똑!! 가족 게시판</h1></header>
            <main>
                <div class="card">
                    <label>제목 <button class="small gray" onclick="toggleEdit('${r.dbId}')">수정</button></label>
                    <input id="view-title" disabled value="${esc(r.title)}">
                    <label>의견</label><textarea id="view-purpose" class="purpose-box" disabled>${esc(r.purpose)}</textarea>
                    <label>계획</label><textarea id="view-plan" class="plan-box" readonly>${esc(r.plan)}</textarea>
                    <label>비용(원)</label><input id="view-cost" disabled type="text" value="${formatComma(r.cost)}">
                </div>
                <div id="parentArea"></div>
                ${getStatus(r) === '대기' ? `<div style="text-align:center;"><button class="btn-parent-input" onclick="openParent('${r.id}')">부모 의견 입력</button></div>` : ''}
                <div class="btn-row"><button class="gray" onclick="navigate({page:'list'})">목록</button><button class="red" onclick="askDelete('${r.dbId}')">삭제</button></div>
            </main>`;
    }
    else if(route.page === "calendar"){ renderCalendarView(app); }
    else if(route.page === "calDetail"){ renderCalendarDetail(app); }
}

/* --- 공통 유틸리티 함수 --- */
function goHome() { navigate({page:'list'}); }
function navigate(p, push=true){ route = p; if(push) history.pushState(p, ""); render(); }
function getStatus(r){ const mom = r.mom || "pending", dad = r.dad || "pending"; if(mom === "pending" || dad === "pending") return "대기"; return (mom === "approve" && dad === "approve") ? "찬성" : "반대"; }
function badge(s){ return `<span class="badge ${s==='찬성'?'ok':(s==='반대'?'no':'wait')}">${s}</span>`; }
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function formatComma(v){ return String(v).replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function now(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }

function confirmSubmit() {
  const t = document.getElementById("t").value.trim();
  const rawC = document.getElementById("c").value.replace(/,/g, '');
  db.ref(`data/${SPACE_ID}/approvals`).push({ id: Date.now().toString(), title:t, purpose:document.getElementById("p").value, plan:document.getElementById("pl").value, cost:rawC, time:now(), mom: "pending", dad: "pending", momC: "", dadC: "", momTime: "", dadTime: "" }).then(() => navigate({page:'list'}));
}

function openParent(id){
    const pw = prompt("부모 비밀번호를 입력하세요.");
    if(pw === spaceConfig.parentPw) {
        const r = allData.find(x=>String(x.id)===String(id));
        let h = `<div class="card"><b>부모 의견 입력</b><textarea id="p_comm" rows="3" placeholder="의견을 입력하세요"></textarea>
                 <div class="btn-row"><button class="green" onclick="decide('${r.dbId}','approve')">찬성</button><button class="red" onclick="decide('${r.dbId}','reject')">반대</button></div></div>`;
        document.getElementById("parentArea").innerHTML = h;
    } else if(pw !== null) alert("비밀번호가 틀렸습니다.");
}

function decide(dbId, val){
    const comm = document.getElementById("p_comm").value;
    const who = prompt("누구신가요? (엄마/아빠)");
    const field = who === '엄마' ? 'mom' : 'dad';
    db.ref(`data/${SPACE_ID}/approvals/${dbId}`).update({ [field]: val, [field+"C"]: comm, [field+"Time"]: now() }).then(() => render());
}

function askDelete(dbId){
    if(prompt("부모 비밀번호를 입력하세요.") === spaceConfig.parentPw) {
        db.ref(`data/${SPACE_ID}/approvals/${dbId}`).remove().then(() => navigate({page:'list'}));
    } else alert("비밀번호 불일치");
}

// 캘린더 등 기타 기능은 SPACE_ID 경로를 사용하도록 유지...
// (이하 생략 - 전체 기능이 SPACE_ID 기반으로 동작하도록 위 startBoard에서 경로가 설정됨)

init(); // 실행 시작
</script>
</body>
</html>
