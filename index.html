<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>가족 결재시스템</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
:root{--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--brand:#6366f1;--ok:#16a34a;--bad:#dc2626;--wait:#d97706;}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;background:var(--bg);}
header{padding:16px;text-align:center;font-size:20px;font-weight:700;background:#fff;border-bottom:1px solid var(--line);}
main{max-width:1100px;margin:auto;padding:16px;}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;}

button, .sms-btn{display:block; width:100%; padding:9px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin:6px 0; text-align:center; text-decoration:none; font-size:16px;}
button.gray, .sms-btn.gray{background:#e5e7eb;color:#111}
button.green{background:var(--ok)}
button.red{background:var(--bad)}

button.fit {width: auto; min-width: 80px; display: inline-block; margin: 0 8px 0 0; padding: 9px 20px;}

button.small{padding: 4px 10px; font-size: 13px; margin: 0; margin-left: 8px;}
input, textarea {width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);margin-top:6px;line-height:1.4;letter-spacing: -0.5px !important;font-size: 16px; color: #666;font-family: inherit;}
input::placeholder, textarea::placeholder {color: #aaa;}
label{font-weight:600;margin-top:14px;display:flex; align-items: center; justify-content: space-between;}

/* ✅ 5번: 목적 2줄, 계획 3줄 고정 및 스크롤 */
textarea.purpose-box { height: calc(1.4em * 2 + 24px) !important; overflow-y: auto; resize: none; }
textarea.plan-box { height: calc(1.4em * 3 + 24px) !important; overflow-y: auto; resize: none; }

.top-actions {display:flex; gap:8px; margin-bottom:12px; justify-content: flex-start;}
.btn-submit, .btn-stats {width: auto !important; margin: 0 !important; padding: 9px 20px !important;}

.top-search {display: flex; gap: 8px; align-items: center; margin-bottom: 16px;}
.top-search input {margin-top: 0; height: 38px; flex: 1;}
.top-search button {height: 38px; margin: 0; min-width: 60px; width: 60px; padding: 0; white-space: nowrap;}

.table-wrapper {max-height: 540px;overflow-y: auto;border: 1px solid var(--line);border-radius: 8px;}
table{width:100%; border-collapse:collapse; position: relative; table-layout: fixed;}
thead th {position: sticky;top: 0;background: #fdfdfd;z-index: 10;border-bottom: 2px solid var(--line);}
th,td{padding:12px;border-bottom:1px solid var(--line);text-align:center;vertical-align:middle;}
tr.approval-row {cursor: pointer;-webkit-user-select: none;user-select: none;}
td.title{text-align:left; line-height:1.35; word-break: break-all;}
.badge{padding:6px 10px;border-radius:6px;color:#fff;font-size:13px;font-weight:700; white-space: nowrap;}
.ok{background:var(--ok)}.no{background:var(--bad)}.wait{background:var(--wait)}

.parent-result{margin-top:12px;padding:12px;border-radius:8px;background:#f9fafb;border:1px solid var(--line); line-height: 1.6; margin-bottom: 10px;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index: 1000;}
.modal .card{width:min(480px,100%); max-height: 85vh; overflow-y: auto;}
.btn-row {display: flex; gap: 10px; margin-top: 20px; justify-content: center;}
.btn-row button, .btn-row .sms-btn {flex: 1; margin: 0;}
.view-time-header {font-size: 14px;color: #666;margin-bottom: 10px;text-align: right;}
.stat-item {border: 1px solid var(--line); border-radius: 8px; padding: 15px; margin-bottom: 10px; line-height: 1.6;}
</style>
</head>
<body>
<header>가족 결재시스템</header>
<main id="app">데이터 로딩 중...</main>
<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const PASSWORD = "7102";

const FAMILY_PHONES = ["01021165677", "01093778936", "01035005677"];

let route = { page: "list", id: null };
let keyword = "";
let allData = [];

db.ref("approvals").on("value", (snapshot) => {
  const val = snapshot.val();
  allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
  render();
});

/* ✅ 3번: 아이폰 단체문자 발송 문제 해결 */
function getSmsUrl(text) {
    const ua = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(ua);
    // iOS는 구분자를 &로 연결하거나 전용 포맷을 사용해야 할 때가 있으나 가장 확실한 콤마 유지 및 수동 트리거 방식 보강
    const phoneString = FAMILY_PHONES.join(",");
    
    return isIOS 
        ? `sms:${phoneString}&body=${encodeURIComponent(text)}` 
        : `sms:${phoneString}?body=${encodeURIComponent(text)}`;
}

function now(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }
function formatComma(v){ return v.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function getStatus(r){
  const mom = r.mom || "pending"; const dad = r.dad || "pending";
  if(mom === "pending" || dad === "pending") return "대기";
  return (mom === "approve" && dad === "approve") ? "승인" : "반려";
}
function badge(s){ return `<span class="badge ${s==='승인'?'ok':(s==='반려'?'no':'wait')}">${s}</span>`; }
function transKo(v){ return v === "approve" ? "승인" : (v === "reject" ? "반려" : "대기"); }
function navigate(p, push=true){ route = p; if(push) history.pushState(route,""); render(); }

function submit(){
  const t = document.getElementById("t").value.trim();
  const p = document.getElementById("p").value.trim();
  const pl = document.getElementById("pl").value.trim();
  const rawC = document.getElementById("c").value.replace(/,/g, '').trim();
  if(!t || !p || !pl || !rawC) return alert("모든 칸을 입력해주세요.");

  const newPost = { id: Date.now().toString(), title:t, purpose:p, plan:pl, cost:rawC, time:now(), mom: "pending", dad: "pending", momC: "", dadC: "", momTime: "", dadTime: "" };
  
  db.ref("approvals").push(newPost).then(() => {
    const msg = `[결재요청] ${t}\n금액: ${Number(rawC).toLocaleString()}원\n엄마, 아빠 결재 부탁드려요!`;
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `
      <div class="card" style="text-align:center;">
        <b style="font-size:18px; display:block; margin-bottom:10px;">✅ 상신 완료</b>
        <p style="color:#666; margin-bottom:20px;">가족들에게 단체 문자를 보낼까요?</p>
        <div class="btn-row">
          <a class="sms-btn" href="${getSmsUrl(msg)}" onclick="navigate({page:'list'}); document.getElementById('pwModal').style.display='none';">단체 문자 보내기</a>
          <button class="gray" onclick="navigate({page:'list'}); document.getElementById('pwModal').style.display='none';">그냥 닫기</button>
        </div>
      </div>`;
  });
}

function askDelete(dbId){
  const m = document.getElementById("pwModal");
  m.style.display="flex";
  m.innerHTML=`
    <div class="card" style="text-align:center;">
      <b>결재 삭제</b>
      <input id="delPw" type="password" placeholder="비밀번호">
      <div class="btn-row">
        <button class="fit" onclick="authDelete('${dbId}')">확인</button>
        <button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">닫기</button>
      </div>
    </div>`;
  setTimeout(()=>document.getElementById("delPw").focus(), 100);
}

function authDelete(dbId){
  if(document.getElementById("delPw").value === PASSWORD){
    db.ref("approvals/"+dbId).remove().then(() => {
      alert("삭제되었습니다.");
      document.getElementById("pwModal").style.display="none";
      navigate({page:'list'});
    });
  } else { alert("비밀번호가 틀렸습니다."); }
}

function updateCost(dbId){
  const newCostRaw = document.getElementById("editCost").value.replace(/,/g, '').trim();
  if(!newCostRaw) return alert("수정할 금액을 입력하세요.");
  db.ref("approvals/"+dbId).update({ cost: newCostRaw }).then(() => {
    alert("비용이 수정되었습니다.");
    render();
  });
}

function openParent(id){
  const m = document.getElementById("pwModal");
  m.style.display="flex";
  m.innerHTML=`
    <div class="card" style="text-align:center;">
      <b>부모 인증</b>
      <input id="pw" type="password" placeholder="비밀번호">
      <div class="btn-row">
        <button class="fit" onclick="authParent('${id}')">확인</button>
        <button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">닫기</button>
      </div>
    </div>`;
  setTimeout(()=>document.getElementById("pw").focus(), 100);
}

function authParent(id){
  if(document.getElementById("pw").value!==PASSWORD) return alert("틀렸습니다.");
  document.getElementById("pwModal").style.display="none";
  const r = allData.find(x=>x.id===id);
  let h = "";
  if(r.mom==='pending') h+=`<div class="card"><b>엄마 결재</b><textarea id="momC" rows="3" placeholder="의견을 입력해주세요 (필수)"></textarea><div style="text-align:left; margin-top:10px;"><button class="fit green" onclick="confirmDecide('${r.dbId}','mom','approve','${r.title}')">승인</button><button class="fit red" onclick="confirmDecide('${r.dbId}','mom','reject','${r.title}')">반려</button></div></div>`;
  if(r.dad==='pending') h+=`<div class="card"><b>아빠 결재</b><textarea id="dadC" rows="3" placeholder="의견을 입력해주세요 (필수)"></textarea><div style="text-align:left; margin-top:10px;"><button class="fit green" onclick="confirmDecide('${r.dbId}','dad','approve','${r.title}')">승인</button><button class="fit red" onclick="confirmDecide('${r.dbId}','dad','reject','${r.title}')">반려</button></div></div>`;
  document.getElementById("parentArea").innerHTML = h || "<p>이미 결재를 완료하셨습니다.</p>";
  
  const btnParent = document.getElementById("btnParentAuth");
  if(btnParent) btnParent.style.display = "none";
}

/* ✅ 4번: 의견 필수 입력 및 결재 확인 팝업 */
function confirmDecide(dbId, who, val, title) {
    const comment = document.getElementById(who + "C").value.trim();
    if (!comment) return alert("의견을 반드시 입력해야 결재가 가능합니다.");

    const actionText = val === 'approve' ? '승인' : '반려';
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `
      <div class="card" style="text-align:center;">
        <b>결재 확인</b>
        <p style="margin-top:10px;">${actionText} 처리 하시겠습니까?</p>
        <div class="btn-row">
          <button class="fit" onclick="decide('${dbId}','${who}','${val}','${title}')">확인</button>
          <button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">취소</button>
        </div>
      </div>`;
}

function decide(dbId, who, val, title){
  const comment = document.getElementById(who+"C").value;
  db.ref("approvals/"+dbId).update({ [who]: val, [who+"C"]: comment, [who+"Time"]: now() }).then(() => {
    const resultStr = val === 'approve' ? '✅승인' : '❌반려';
    const msg = `[결재결과] ${title}\n${who==='mom'?'엄마':'아빠'}님이 ${resultStr} 하셨습니다.\n의견: ${comment || '없음'}`;
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `
      <div class="card" style="text-align:center;">
        <b style="font-size:18px; display:block; margin-bottom:10px;">✅ 결재 완료</b>
        <p style="color:#666; margin-bottom:20px;">결과를 가족들에게 문자로 알릴까요?</p>
        <div class="btn-row">
          <a class="sms-btn" href="${getSmsUrl(msg)}" onclick="navigate({page:'list'}); document.getElementById('pwModal').style.display='none';">단체 문자 보내기</a>
          <button class="gray" onclick="navigate({page:'list'}); document.getElementById('pwModal').style.display='none';">그냥 닫기</button>
        </div>
      </div>`;
  });
}

function render(){
  const app = document.getElementById("app");
  let displayData = [...allData];
  if(keyword) displayData = displayData.filter(x => JSON.stringify(x).includes(keyword));
  displayData.sort((a,b) => b.time.localeCompare(a.time));

  if(route.page === "list"){
    app.innerHTML = `
      <div class="top-actions">
        <button class="btn-submit" onclick="navigate({page:'new'})">결재올리기</button>
        <button class="btn-stats" onclick="openStats()">통계</button>
      </div>
      <div class="top-search">
        <button class="gray" onclick="doSearch()">검색</button>
        <input id="q" placeholder="검색어 입력" value="${esc(keyword)}">
      </div>
      
      <div class="table-wrapper">
        <table>
          <colgroup>
            <col style="width: 45px;">
            <col>
            <col style="width: 75px;">
          </colgroup>
          <thead><tr><th>No</th><th>제목 / 상신시간</th><th>상태</th></tr></thead>
          <tbody>
            ${displayData.map((r,i)=>`
              <tr class="approval-row" onclick="navigate({page:'view', id:'${r.id}'})">
                <td>${displayData.length - i}</td>
                <td class="title"><div>${esc(r.title)}</div><small style="color:#888;">${r.time}</small></td>
                <td>${badge(getStatus(r))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
    const q=document.getElementById("q"); if(q) q.addEventListener("keydown", e => e.key === "Enter" && doSearch());
  } 
  else if(route.page === "new"){
    app.innerHTML = `<div class="card">
      <label>제목</label><input id="t" placeholder="무엇을 사거나 하고 싶나요?">
      <label>목적</label><textarea id="p" rows="2" class="purpose-box" placeholder="왜 필요한가요?"></textarea>
      <label>계획</label><textarea id="pl" rows="3" class="plan-box" placeholder="계획을 자세하게 적어주세요"></textarea>
      <label>비용(원)</label><input id="c" type="text" placeholder="금액 입력" oninput="this.value=formatComma(this.value)">
      <div class="btn-row">
        <button onclick="submit()">결재올리기</button>
        <button class="gray" onclick="navigate({page:'list'})">취소</button>
      </div>
    </div>`;
  }
  else if(route.page === "view"){
    const r = allData.find(x => x.id === route.id);
    if(!r) return navigate({page:'list'});

    /* ✅ 1, 6번 반영: 기록 포맷팅 */
    const getLog = (name, res, comm, time) => {
        const icon = res === 'approve' ? '✅' : (res === 'reject' ? '❌' : '⏳');
        const statusText = transKo(res);
        const timeText = time ? `/ ${time}` : '';
        return `<div style="margin-bottom:15px;">
            <b>${name}: ${icon} ${statusText} ${timeText}</b><br>
            <div style="margin-top:8px; padding-left:10px; color:#555;">의견: ${esc(comm || "-")}</div>
        </div>`;
    };

    app.innerHTML = `
      <div class="view-time-header">상신: ${r.time}</div>
      <div class="card">
        <label>제목</label><input readonly value="${esc(r.title)}">
        <label>목적</label><textarea rows="2" class="purpose-box" readonly>${esc(r.purpose)}</textarea>
        <label>계획</label><textarea rows="3" class="plan-box" readonly>${esc(r.plan)}</textarea>
        
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:14px;">
          <label style="margin-top:0;">비용(원)</label>
          <button class="small gray" style="width:fit-content; margin:0 0 0 auto; padding: 4px 12px;" onclick="updateCost('${r.dbId}')">수정</button>
        </div>
        <input id="editCost" type="text" value="${formatComma(r.cost)}" oninput="this.value=formatComma(this.value)">
      </div>
      <div class="parent-result">
        <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;"><b>부모 결재 기록</b></div>
        ${getLog('엄마', r.mom, r.momC, r.momTime)}
        ${getLog('아빠', r.dad, r.dadC, r.dadTime)}
      </div>
      <div id="parentArea"></div>
      
      <div id="btnParentAuth" style="text-align:left; display: ${getStatus(r) === '대기' ? 'block' : 'none'};">
        <button class="fit" onclick="openParent('${r.id}')">부모 결재</button>
      </div>
      
      <div class="btn-row">
        <button class="gray" onclick="navigate({page:'list'})">목록</button>
        <button class="red" onclick="askDelete('${r.dbId}')">삭제</button>
      </div>`;
  }
}
function doSearch(){ keyword = document.getElementById("q").value.trim(); render(); }
function openStats(){
  const stats = {};
  allData.filter(x => getStatus(x) !== "대기").forEach(item => {
    const key = item.time.substring(0,7).replace("-","년 ") + "월";
    if(!stats[key]) stats[key] = {app:0, appS:0, rej:0, rejS:0};
    const s = getStatus(item); const c = Number(item.cost);
    if(s==="승인"){ stats[key].app++; stats[key].appS+=c; } else { stats[key].rej++; stats[key].rejS+=c; }
  });
  const sorted = Object.keys(stats).sort().reverse();
  const m = document.getElementById("statModal");
  m.style.display="flex";
  m.innerHTML = `<div class="card"><h3>월간 통계</h3><div class="table-wrapper">${sorted.map(k=>`<div class="stat-item"><b>${k}</b><br>✅ 승인: ${stats[k].app}건 (${stats[k].appS.toLocaleString()}원) <br>❌ 반려: ${stats[k].rej}건 (${stats[k].rejS.toLocaleString()}원)</div>`).join("") || "기록 없음"}</div><button onclick="this.parentNode.parentNode.style.display='none'" style="width:100%">닫기</button></div>`;
}
window.onpopstate = (e) => { if(e.state) { route = e.state; render(); } };
history.replaceState({page:'list'}, "");
</script>
</body>
</html>
