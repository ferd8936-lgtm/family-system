<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>ê°€ì¡± ê²°ì¬ì‹œìŠ¤í…œ</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
:root{--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--brand:#6366f1;--ok:#16a34a;--bad:#dc2626;--wait:#d97706;}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;background:var(--bg);}
header{padding:16px;text-align:center;font-size:20px;font-weight:700;background:#fff;border-bottom:1px solid var(--line);}
main{max-width:1100px;margin:auto;padding:16px;}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;}
button{padding:12px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin:6px 0;}
button.gray{background:#e5e7eb;color:#111}
button.green{background:var(--ok)}
button.red{background:var(--bad)}
button.kakao{background:#fee500; color:#3c1e1e; width: 100%; margin-top: 10px;}
input, textarea {width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);margin-top:6px;line-height:1.4;font-size: 16px; color: #333; font-family: inherit;}
label{font-weight:600;margin-top:14px;display:block;}
.table-wrapper {border: 1px solid var(--line);border-radius: 8px;background:#fff;overflow:hidden;}
table{width:100%; border-collapse:collapse;}
th,td{padding:14px;border-bottom:1px solid var(--line);text-align:center;}
tr:last-child td{border-bottom:none;}
td.title{text-align:left;line-height:1.4;}
.badge{padding:6px 10px;border-radius:6px;color:#fff;font-size:12px;font-weight:700;}
.ok{background:var(--ok)}.no{background:var(--bad)}.wait{background:var(--wait)}
.parent-result{margin-top:12px;padding:12px;border-radius:8px;background:#f9fafb;border:1px solid var(--line); line-height: 1.6; font-size:14px;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index: 1000;}
.modal .card{width:min(400px,100%);}
.btn-group {display: flex; gap: 8px;}
.btn-group button {flex: 1;}
</style>
</head>
<body>
<header>ê°€ì¡± ê²°ì¬ì‹œìŠ¤í…œ</header>
<main id="app">ë°ì´í„° ë¡œë”© ì¤‘...</main>
<div id="pwModal" class="modal"></div>

<script>
/* 1. Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const PASSWORD = "7102";

let route = { page: "list", id: null };
let allData = [];

/* 2. ë°ì´í„° ìˆ˜ì‹  */
db.ref("approvals").on("value", (snapshot) => {
  const val = snapshot.val();
  allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
  render();
});

/* 3. ìœ í‹¸ë¦¬í‹° */
function now(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }
function formatComma(v){ return v.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function esc(s){ return String(s??"").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function navigate(p){ route = p; render(); }
function getStatus(r){
  if((r.mom||'pending')==='approve' && (r.dad||'pending')==='approve') return 'ìŠ¹ì¸';
  if(r.mom==='reject' || r.dad==='reject') return 'ë°˜ë ¤';
  return 'ëŒ€ê¸°';
}

/* 4. ê²°ì¬ ìƒì‹  ë° ì¹´í†¡ ì—°ë™ */
function submit(){
  const t = document.getElementById("t").value.trim();
  const p = document.getElementById("p").value.trim();
  const rawC = document.getElementById("c").value.replace(/,/g, '').trim();
  if(!t || !p || !rawC) return alert("ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”.");

  const newPost = { id: Date.now().toString(), title:t, purpose:p, cost:rawC, time:now(), mom:"pending", dad:"pending", momC:"", dadC:"" };
  
  db.ref("approvals").push(newPost).then(() => {
    const msg = `ğŸ“¢ ê²°ì¬ê°€ ìƒì‹ ë˜ì—ˆìŠµë‹ˆë‹¤!\nì œëª©: ${t}\në¹„ìš©: ${formatComma(rawC)}ì›\n\ní™•ì¸í•˜ê¸°:\n${window.location.href}`;
    if(confirm("ìƒì‹  ì™„ë£Œ! ê°€ì¡±ì—ê²Œ ì¹´í†¡ ì•Œë¦¼ì„ ë³´ë‚¼ê¹Œìš”?")) {
        window.location.href = "kakaolink://send?text=" + encodeURIComponent(msg);
    }
    navigate({page:'list'});
  });
}

/* 5. ì‚­ì œ ê¸°ëŠ¥ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸) */
function askDelete(dbId){
  const pw = prompt("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(pw === PASSWORD){
    db.ref("approvals/"+dbId).remove().then(() => {
      alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      navigate({page:'list'});
    });
  } else if(pw !== null) {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  }
}

/* 6. ë¶€ëª¨ ê²°ì¬ ì²˜ë¦¬ */
function openParent(id){
  const m = document.getElementById("pwModal");
  m.style.display="flex";
  m.innerHTML=`<div class="card"><b>ë¶€ëª¨ ì¸ì¦</b><input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><button onclick="authParent('${id}')">í™•ì¸</button><button class="gray" onclick="this.parentNode.parentNode.style.display='none'">ë‹«ê¸°</button></div>`;
}
function authParent(id){
  if(document.getElementById("pw").value!==PASSWORD) return alert("í‹€ë ¸ìŠµë‹ˆë‹¤.");
  document.getElementById("pwModal").style.display="none";
  const r = allData.find(x=>x.id===id);
  let h = "";
  if(r.mom==='pending') h+=`<div class="card"><b>ì—„ë§ˆ ê²°ì¬</b><textarea id="mC" placeholder="ì˜ê²¬"></textarea><div class="btn-group"><button class="green" onclick="decide('${r.dbId}','mom','approve')">ìŠ¹ì¸</button><button class="red" onclick="decide('${r.dbId}','mom','reject')">ë°˜ë ¤</button></div></div>`;
  if(r.dad==='pending') h+=`<div class="card"><b>ì•„ë¹  ê²°ì¬</b><textarea id="dC" placeholder="ì˜ê²¬"></textarea><div class="btn-group"><button class="green" onclick="decide('${r.dbId}','dad','approve')">ìŠ¹ì¸</button><button class="red" onclick="decide('${r.dbId}','dad','reject')">ë°˜ë ¤</button></div></div>`;
  document.getElementById("parentArea").innerHTML = h || "<p>ì´ë¯¸ ê²°ì¬ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.</p>";
}
function decide(dbId, who, val){
  const updates = {};
  updates[who] = val;
  updates[who+"C"] = document.getElementById(who==='mom'?'mC':'dC').value;
  db.ref("approvals/"+dbId).update(updates).then(() => navigate({page:'list'}));
}

/* 7. í™”ë©´ ë Œë”ë§ */
function render(){
  const app = document.getElementById("app");
  if(route.page === "list"){
    const list = [...allData].sort((a,b)=>b.time.localeCompare(a.time));
    app.innerHTML = `
      <button style="width:100%;margin-bottom:16px;" onclick="navigate({page:'new'})">ìƒˆ ê²°ì¬ ì˜¬ë¦¬ê¸° +</button>
      <div class="table-wrapper">
        <table>
          <thead><tr style="background:#fdfdfd;"><th>ì œëª© / ì¼ì‹œ</th><th>ìƒíƒœ</th></tr></thead>
          <tbody>
            ${list.map(r=>`
              <tr onclick="navigate({page:'view', id:'${r.id}'})" style="cursor:pointer">
                <td class="title"><b>${esc(r.title)}</b><br><small style="color:#888">${r.time}</small></td>
                <td><span class="badge ${getStatus(r)==='ìŠ¹ì¸'?'ok':(getStatus(r)==='ë°˜ë ¤'?'no':'wait')}">${getStatus(r)}</span></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
  } 
  else if(route.page === "new"){
    app.innerHTML = `<div class="card">
      <label>ì œëª©</label><input id="t" placeholder="ì˜ˆ: ê°„ì‹ êµ¬ë§¤">
      <label>ëª©ì </label><textarea id="p" rows="3"></textarea>
      <label>ë¹„ìš©(ì›)</label><input id="c" type="text" oninput="this.value=formatComma(this.value)">
      <button style="width:100%;margin-top:20px;" onclick="submit()">ê²°ì¬ ìƒì‹ </button>
      <button class="gray" style="width:100%;" onclick="navigate({page:'list'})">ì·¨ì†Œ</button>
    </div>`;
  }
  else if(route.page === "view"){
    const r = allData.find(x=>x.id===route.id);
    if(!r) return navigate({page:'list'});
    app.innerHTML = `
      <div class="card">
        <label>ì œëª©</label><input readonly value="${esc(r.title)}">
        <label>ëª©ì </label><textarea readonly rows="3">${esc(r.purpose)}</textarea>
        <label>ë¹„ìš©</label><input readonly value="${Number(r.cost).toLocaleString()} ì›">
        <div class="parent-result">
          <b>ê²°ì¬ í˜„í™©</b><br>
          ì—„ë§ˆ: ${r.mom==='approve'?'ìŠ¹ì¸':(r.mom==='reject'?'ë°˜ë ¤':'ëŒ€ê¸°')} (${esc(r.momC||'-')})<br>
          ì•„ë¹ : ${r.dad==='approve'?'ìŠ¹ì¸':(r.dad==='reject'?'ë°˜ë ¤':'ëŒ€ê¸°')} (${esc(r.dadC||'-')})
        </div>
      </div>
      <div id="parentArea"></div>
      <button style="width:100%;" onclick="openParent('${r.id}')">ë¶€ëª¨ ê²°ì¬í•˜ê¸°</button>
      <div class="btn-group">
        <button class="gray" onclick="navigate({page:'list'})">ëª©ë¡ìœ¼ë¡œ</button>
        <button class="red" onclick="askDelete('${r.dbId}')">ì‚­ì œí•˜ê¸°</button>
      </div>`;
  }
}

render();
</script>
</body>
</html>
