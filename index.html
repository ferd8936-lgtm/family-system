<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>똑똑!! 가족 게시판</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
@font-face {
    font-family: 'NexonLv2Gothic';
    src: url('NexonLv2Gothic_2.ttf') format('truetype');
}
:root{--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--brand:#6366f1;--ok:#16a34a;--bad:#dc2626;--wait:#d97706;}
*{box-sizing:border-box}
html, body { overscroll-behavior-y: none; height: 100%; }
body, button, input, textarea {margin:0; font-family:'NexonLv2Gothic', sans-serif; background:var(--bg);}
header{padding:20px 16px;text-align:center;background:#fff;border-bottom:1px solid var(--line);}
header h1 {margin:0; font-size:24px; font-weight:700; cursor: pointer; display: inline-block;}
header p {margin:8px 0 0; font-size:16.8px; color:#666; line-height: 1.4;}

main{max-width:1100px;margin:auto;padding:16px;}
body.full-view main { max-width: 100%; padding: 0; height: calc(100% - 60px); }
body.full-view header { border-bottom: none; }

.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;}

button, .sms-btn{display:block; width:100%; padding:9px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin:6px 0; text-align:center; text-decoration:none; font-size:16px; font-family: inherit;}
button.gray, .sms-btn.gray{background:#e5e7eb;color:#111}
button.green{background:var(--ok)}
button.red{background:var(--bad)}

button.fit {width: auto; min-width: 80px; display: inline-block; margin: 0 8px 0 0; padding: 9px 20px;}
.btn-parent-input { width: auto !important; padding: 10px 30px !important; }

button.small{padding: 4px 10px; font-size: 13px; margin: 0;}
input, textarea {width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);margin-top:6px;line-height:1.4;letter-spacing: -0.5px !important;font-size: 16px; color: #333;font-family: inherit; background: transparent;}
input:disabled, textarea:disabled { background: transparent; color: #333; border-color: #eee; }
input::placeholder, textarea::placeholder { color: #aaa; }
label{font-weight:600;margin-top:14px;display:flex; align-items: center; justify-content: space-between;}

textarea.purpose-box, textarea.plan-box { height: 100px !important; min-height: 100px !important; overflow-y: auto !important; resize: none; }

.top-actions {display:flex; gap:8px; margin-bottom:12px; justify-content: flex-start; align-items: center;}
.btn-submit, .btn-stats, .btn-cal {width: auto !important; margin: 0 !important; padding: 8px 18px !important;}
.btn-cal { margin-left: auto !important; background: #4b5563; }

.top-search {display: flex; gap: 8px; align-items: center; margin-bottom: 16px;}
.top-search input {margin-top: 0; height: 38px; flex: 1;}
.top-search button {height: 38px; margin: 0; min-width: 60px; width: 60px; padding: 0; white-space: nowrap;}

.table-wrapper {max-height: 540px;overflow-y: auto;border: 1px solid var(--line);border-radius: 8px;}
table{width:100%; border-collapse:collapse; position: relative; table-layout: fixed;}
thead th {position: sticky;top: 0;background: #fdfdfd;z-index: 10;border-bottom: 2px solid var(--line);}
th,td{padding:12px;border-bottom:1px solid var(--line);text-align:center;vertical-align:middle;}
tr.approval-row {cursor: pointer;-webkit-user-select: none;user-select: none;}
td.title{text-align:left; line-height:1.35; word-break: break-all;}
.badge{padding:6px 10px;border-radius:6px;color:#fff;font-size:13px;font-weight:700; white-space: nowrap;}
.ok{background:var(--ok)}.no{background:var(--bad)}.wait{background:var(--wait)}
.new-badge {background:#dc2626; color:#fff; font-size:10px; padding:2px 4px; border-radius:4px; margin-right:4px; vertical-align: middle; font-weight: bold;}

.parent-result{margin-top:12px;padding:12px;border-radius:8px;background:#f9fafb;border:1px solid var(--line); line-height: 1.6; margin-bottom: 10px;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index: 1000;}
.modal .card{width:min(480px,100%); max-height: 85vh; overflow-y: auto;}
.btn-row {display: flex; gap: 10px; margin-top: 20px; justify-content: center;}
.btn-row button, .btn-row .sms-btn {flex: 1; margin: 0;}
.view-time-header {font-size: 14px;color: #666;margin-bottom: 10px;text-align: right;}

/* 2. 캘린더 메인 화면 비율 최적화 */
.cal-wrapper { background: #fff; height: 100%; display: flex; flex-direction: column; overflow: hidden; touch-action: none; position: relative; width: 100%; }
.cal-container { display: flex; width: 300%; height: 100%; transition: transform 0.3s ease-out; }
.cal-month-view { width: 33.333%; height: 100%; display: flex; flex-direction: column; }

.cal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--line); }
.cal-header button { width: 34px !important; height: 34px; padding: 0 !important; font-size: 14px; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--line); gap: 1px; flex: 1; border-bottom: 1px solid var(--line); width: 100%; }

/* 요일 칸 세로 사이즈 및 가운데 정렬 수정 */
.cal-day-label { background: #fdfdfd; height: 18px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 12px; font-weight: bold; line-height: 1; }

.cal-day { background: #fff; padding: 4px; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; gap: 2px; position: relative; overflow: hidden; }
.cal-day.sun { color: red; }
.cal-day.sat { color: blue; }
.cal-day.other { color: #ccc !important; background: #fafafa; }
.cal-day.other .cal-event-item { opacity: 0.4; }
.cal-day.today { background: #fff; } 
.today-text { font-size: 8px; color: var(--brand); font-weight: bold; margin-left: 2px; }

.cal-event-container { display: flex; flex-direction: column; gap: 1px; overflow: hidden; }
.cal-event-item { 
    color: #000; 
    background-color: #eef2ff; 
    padding: 1px 2px; 
    border-radius: 2px; 
    font-size: 9px;
    line-height: 1.1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.cal-footer { padding: 10px 15px; background: var(--bg); }
.stat-item {border: 1px solid var(--line); border-radius: 8px; padding: 15px; margin-bottom: 10px; line-height: 1.6;}
</style>
</head>
<body>
<header id="main-header">
    <h1 onclick="goHome()">똑똑!! 가족 게시판</h1>
    <p>엄마와 아빠는 언제나 너의 멋진 계획을 응원해!</p>
</header>
<main id="app">데이터 로딩 중...</main>
<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const PASSWORD = "7102";

let route = { page: "list", id: null, date: null };
let keyword = "";
let allData = [];
let calendarData = {};
let currentCalDate = new Date();
let tempParentInput = { momC: "", dadC: "" };

db.ref("approvals").on("value", (snapshot) => {
  const val = snapshot.val();
  allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
  if(route.page === "list" || route.page === "view") render();
});

db.ref("calendar_v3").on("value", (snapshot) => {
  calendarData = snapshot.val() || {};
  if(route.page === 'calendar' || route.page === 'calDetail') render();
});

function goHome() { navigate({page:'list'}); }

function navigate(p, push=true){ 
  route = p; 
  if(push) {
      if(p.page === 'list') {
          window.history.pushState(null, "", window.location.pathname);
          window.history.replaceState(p, "");
      } else {
          history.pushState(p, "");
      }
  }
  render(); 
}

function render(){
  const app = document.getElementById("app");
  const header = document.getElementById("main-header");
  document.body.classList.remove("full-view");
  header.style.display = (route.page === "calendar") ? "none" : "block";

  if(route.page === "list"){
    let displayData = [...allData];
    if(keyword) displayData = displayData.filter(x => JSON.stringify(x).includes(keyword));
    displayData.sort((a,b) => b.time.localeCompare(a.time));
    const readList = JSON.parse(localStorage.getItem('readApprovals') || '[]');

    app.innerHTML = `
      <div class="top-actions">
        <button class="btn-submit" onclick="navigate({page:'new'})">의견 올리기</button>
        <button class="btn-stats" onclick="openStats()">통계</button>
        <button class="btn-cal" onclick="navigate({page:'calendar'})">캘린더</button>
      </div>
      <div class="top-search">
        <button class="gray" onclick="doSearch()">검색</button>
        <input id="q" placeholder="검색어 입력" value="${esc(keyword)}">
      </div>
      <div class="table-wrapper">
        <table>
          <colgroup><col style="width: 45px;"><col><col style="width: 75px;"></colgroup>
          <thead><tr><th>No</th><th>제목 / 상신시간</th><th>상태</th></tr></thead>
          <tbody>
            ${displayData.map((r,i)=>{
              const status = getStatus(r);
              const isNew = !readList.includes(r.id) && status === '대기';
              return `<tr class="approval-row" onclick="navigate({page:'view', id:'${r.id}'})">
                  <td>${displayData.length - i}</td>
                  <td class="title"><div>${isNew ? '<span class="new-badge">NEW</span>' : ''}${esc(r.title)}</div><small style="color:#888;">${r.time}</small></td>
                  <td>${badge(status)}</td>
                </tr>`;
            }).join("")}
          </tbody>
        </table>
      </div>`;
  } 
  else if(route.page === "new"){
    app.innerHTML = `<div class="card">
      <label>제목</label><input id="t" placeholder="무엇을 사거나 하고 싶나요?">
      <label>의견</label><textarea id="p" class="purpose-box" placeholder="왜 필요한가요?"></textarea>
      <label>계획</label><textarea id="pl" class="plan-box" placeholder="계획을 자세하게 적어주세요"></textarea>
      <label>비용(원)</label><input id="c" type="text" placeholder="금액 입력" oninput="this.value=formatComma(this.value)">
      <div class="btn-row"><button onclick="confirmSubmit()">의견 올리기</button><button class="gray" onclick="navigate({page:'list'})">취소</button></div>
    </div>`;
  }
  else if(route.page === "view"){
    const r = allData.find(x => String(x.id) === String(route.id));
    if(!r) return navigate({page:'list'});
    
    const showParentBtn = document.getElementById("parentArea") && document.getElementById("parentArea").innerHTML !== "" ? "none" : "block";

    app.innerHTML = `
      <div class="view-time-header">상신: ${r.time}</div>
      <div class="card">
        <label style="margin-top:0;">제목<button id="btnEditMain" class="small gray" style="width: auto; margin-left: auto;" onclick="toggleEdit('${r.dbId}')">수정</button></label>
        <input id="view-title" disabled value="${esc(r.title)}">
        <label>의견</label><textarea id="view-purpose" class="purpose-box" disabled>${esc(r.purpose)}</textarea>
        <label>계획</label><textarea id="view-plan" class="plan-box" disabled>${esc(r.plan)}</textarea>
        <label>비용(원)</label><input id="view-cost" disabled type="text" value="${formatComma(r.cost)}">
      </div>
      <div id="parentViewLog" class="parent-result"><div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;"><b>부모 의견 기록</b></div>
        ${renderLog('엄마', r.mom, r.momC, r.momTime)}${renderLog('아빠', r.dad, r.dadC, r.dadTime)}
      </div>
      <div id="parentArea"></div>
      <div id="parentBtnWrapper" style="text-align:center; margin-bottom:10px; display: ${showParentBtn};">
        <button class="btn-parent-input" onclick="openParent('${r.id}')">부모 의견 입력</button>
      </div>
      <div class="btn-row"><button class="gray" onclick="navigate({page:'list'})">목록</button><button class="red" onclick="askDelete('${r.dbId}')">삭제</button></div>`;
  }
  else if(route.page === "calendar"){ document.body.classList.add("full-view"); renderCalendarView(app); }
  else if(route.page === "calDetail"){ renderCalendarDetail(app); }
}

function getSmsUrl(text) {
    const ua = navigator.userAgent.toLowerCase();
    return /iphone|ipad|ipod/.test(ua) ? `sms:&body=${encodeURIComponent(text)}` : `sms:?body=${encodeURIComponent(text)}`;
}

function confirmSubmit() {
  const t = document.getElementById("t").value.trim();
  const p = document.getElementById("p").value.trim();
  const pl = document.getElementById("pl").value.trim();
  const rawC = document.getElementById("c").value.replace(/,/g, '').trim();
  if(!t || !p || !pl || !rawC) return alert("모든 칸을 입력해주세요.");
  const m = document.getElementById("pwModal"); m.style.display = "flex";
  m.innerHTML = `<div class="card" style="text-align:center;"><b>의견 상신 확인</b><p style="margin-top:10px;">이대로 의견을 올릴까요?</p><div class="btn-row"><button class="fit" onclick="submit()">확인</button><button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">취소</button></div></div>`;
}

function submit(){
  const t = document.getElementById("t").value.trim();
  const rawC = document.getElementById("c").value.replace(/,/g, '').trim();
  const p = document.getElementById("p").value.trim();
  const pl = document.getElementById("pl").value.trim();
  const newPost = { id: Date.now().toString(), title:t, purpose:p, plan:pl, cost:rawC, time:now(), mom: "pending", dad: "pending", momC: "", dadC: "", momTime: "", dadTime: "" };
  
  db.ref("approvals").push(newPost).then(() => {
    const msg = `[똑똑! 가족게시판]\n아이의 의견이 접수되었습니다\n\n제목 : ${t}\n금액 : ${Number(rawC).toLocaleString()}원`;
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;">
        <b style="font-size:18px; display:block; margin-bottom:10px;">✅ 상신 완료</b>
        <p style="color:#666; margin-bottom:20px;">가족들에게 문자를 보낼까요?</p>
        <div class="btn-row">
          <a class="sms-btn" href="${getSmsUrl(msg)}" onclick="document.getElementById('pwModal').style.display='none'; navigate({page:'list'});">문자 보내기</a>
          <button class="gray" onclick="document.getElementById('pwModal').style.display='none'; navigate({page:'list'});">그냥 닫기</button>
        </div>
      </div>`;
  });
}

function renderCalendarView(container) {
    const currentYear = currentCalDate.getFullYear();
    const currentMonth = currentCalDate.getMonth();
    
    container.innerHTML = `
        <div class="cal-wrapper">
            <div class="cal-header">
                <button class="gray small" onclick="changeMonth(-1)">◀</button>
                <b style="font-size:20px;">${currentYear}년 ${currentMonth + 1}월</b>
                <button class="gray small" onclick="changeMonth(1)">▶</button>
            </div>
            <div class="cal-container" id="calContainer">
                <div class="cal-month-view" id="prevMonthView"></div>
                <div class="cal-month-view" id="currMonthView"></div>
                <div class="cal-month-view" id="nextMonthView"></div>
            </div>
            <div class="cal-footer"><button class="gray" onclick="navigate({page:'list'})">게시판으로 돌아가기</button></div>
        </div>
    `;

    renderMonthGrid(new Date(currentYear, currentMonth - 1, 1), document.getElementById('prevMonthView'));
    renderMonthGrid(new Date(currentYear, currentMonth, 1), document.getElementById('currMonthView'));
    renderMonthGrid(new Date(currentYear, currentMonth + 1, 1), document.getElementById('nextMonthView'));

    const calContainer = document.getElementById('calContainer');
    calContainer.style.transform = 'translateX(-33.333%)';

    let startX = 0, currentTranslate = 0, isDragging = false;
    
    calContainer.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        isDragging = true;
        calContainer.style.transition = 'none';
    });

    calContainer.addEventListener('touchmove', e => {
        if (!isDragging) return;
        const touchX = e.touches[0].clientX;
        currentTranslate = touchX - startX;
        const baseTranslate = -window.innerWidth; 
        calContainer.style.transform = `translateX(${baseTranslate + currentTranslate}px)`;
    });

    calContainer.addEventListener('touchend', () => {
        isDragging = false;
        calContainer.style.transition = 'transform 0.3s ease-out';
        const threshold = window.innerWidth / 3;
        if (Math.abs(currentTranslate) > threshold) {
            if (currentTranslate > 0) {
                calContainer.style.transform = 'translateX(0)';
                setTimeout(() => changeMonth(-1), 300);
            } else {
                calContainer.style.transform = 'translateX(-66.666%)';
                setTimeout(() => changeMonth(1), 300);
            }
        } else {
            calContainer.style.transform = 'translateX(-33.333%)';
        }
        currentTranslate = 0;
    });
}

function renderMonthGrid(dateObj, targetElement) {
    const year = dateObj.getFullYear();
    const month = dateObj.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    const prevLastDate = new Date(year, month, 0).getDate();
    
    let html = `
        <div class="cal-grid">
            <div class="cal-day-label sun">일</div><div class="cal-day-label">월</div><div class="cal-day-label">화</div>
            <div class="cal-day-label">수</div><div class="cal-day-label">목</div><div class="cal-day-label">금</div><div class="cal-day-label sat">토</div>
    `;

    for(let i = firstDay - 1; i >= 0; i--) {
        const d = prevLastDate - i;
        const dKey = `${month === 0 ? year-1 : year}-${String(month === 0 ? 12 : month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        html += renderDayCell(year, month - 1, d, dKey, true);
    }
    
    for(let d = 1; d <= lastDate; d++) {
        const dKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        html += renderDayCell(year, month, d, dKey, false);
    }

    const totalCells = 42; 
    const nextCells = totalCells - (firstDay + lastDate);
    for(let d = 1; d <= nextCells; d++) {
        const dKey = `${month === 11 ? year+1 : year}-${String(month === 11 ? 1 : month+2).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        html += renderDayCell(year, month + 1, d, dKey, true);
    }
    
    html += `</div>`;
    targetElement.innerHTML = html;
}

function renderDayCell(y, m, d, dateKey, isOther) {
    const date = new Date(y, m, d);
    const isToday = new Date().toDateString() === date.toDateString();
    let events = calendarData[dateKey] ? Object.values(calendarData[dateKey]) : [];
    events.sort((a, b) => a.time.localeCompare(b.time));
    
    const dayOfWeek = date.getDay();
    let cls = isOther ? 'other' : '';
    if(isToday) cls += ' today';
    if(dayOfWeek === 0) cls += ' sun'; 
    if(dayOfWeek === 6) cls += ' sat';

    return `
        <div class="cal-day ${cls}" onclick="navigate({page:'calDetail', date:'${dateKey}'})">
            <b>${d}${isToday ? '<span class="today-text">TODAY</span>' : ''}</b>
            <div class="cal-event-container">
                ${events.map(ev => `<div class="cal-event-item">${esc(ev.title)} ${ev.time}</div>`).join('')}
            </div>
        </div>`;
}

function renderCalendarDetail(container) {
    const dateKey = route.date;
    let events = calendarData[dateKey] ? Object.entries(calendarData[dateKey]) : [];
    events.sort((a, b) => a[1].time.localeCompare(b[1].time));
    
    container.innerHTML = `
        <div class="card">
            <h2 style="margin-top:0; font-size: 1.2rem;">${dateKey} 일정 추가</h2>
            <label>제목</label><input id="calTitle" placeholder="일정 제목을 입력하세요">
            <label>시간</label><input id="calTime" type="time" value="12:00">
            <label>내용</label><textarea id="calContent" rows="3" placeholder="상세 내용을 입력하세요"></textarea>
            <button onclick="saveCal('${dateKey}')">일정 추가하기</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid var(--line);">
            <b style="display:block; margin-bottom:10px;">저장된 일정 (${events.length})</b>
            ${events.map(([id, ev]) => `
                <div style="background:#f9fafb; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; flex-wrap: nowrap;">
                    <div style="overflow:hidden; flex:1; margin-right:10px;">
                        <small style="color:var(--brand); font-weight:bold;">${ev.time || ''}</small><br>
                        <b style="font-size:14px;">${esc(ev.title || '')}</b><br>
                        <span style="font-size:13px; color:#666;">${esc(ev.content || '')}</span>
                    </div>
                    <button class="small red" style="width:50px; flex-shrink:0; height:30px;" onclick="askDeleteCal('${dateKey}', '${id}')">삭제</button>
                </div>
            `).join('') || '<p style="color:#999; font-size:14px;">저장된 일정이 없습니다.</p>'}
            <button class="gray" style="margin-top:10px;" onclick="navigate({page:'calendar'})">뒤로가기</button>
        </div>`;
}

function askDeleteCal(dateKey, id) {
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;">
        <b>일정 삭제 확인</b>
        <p style="margin-top:10px;">이 일정을 삭제할까요?</p>
        <div class="btn-row">
            <button class="fit red" onclick="doDeleteCal('${dateKey}', '${id}')">삭제</button>
            <button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">취소</button>
        </div>
    </div>`;
}

function doDeleteCal(dateKey, id) {
    db.ref(`calendar_v3/${dateKey}/${id}`).remove().then(() => {
        document.getElementById("pwModal").style.display = "none";
        render();
    });
}

function saveCal(dateKey) {
    const title = document.getElementById("calTitle").value.trim();
    const time = document.getElementById("calTime").value;
    const content = document.getElementById("calContent").value.trim();
    if(!title) return alert("제목을 입력해주세요.");
    db.ref("calendar_v3/" + dateKey).push({ title, time, content }).then(() => { render(); });
}

function changeMonth(diff) {
    currentCalDate.setMonth(currentCalDate.getMonth() + diff);
    render();
}

function now(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }
function formatComma(v){ return String(v).replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function getStatus(r){
  const mom = r.mom || "pending"; const dad = r.dad || "pending";
  if(mom === "pending" || dad === "pending") return "대기";
  return (mom === "approve" && dad === "approve") ? "찬성" : "반대";
}
function badge(s){ return `<span class="badge ${s==='찬성'?'ok':(s==='반대'?'no':'wait')}">${s}</span>`; }
function transKo(v){ return v === "approve" ? "찬성" : (v === "reject" ? "반대" : "대기"); }
function renderLog(name, res, comm, time) {
    const icon = res === 'approve' ? '✅' : (res === 'reject' ? '❌' : '⏳');
    return `<div style="margin-bottom:15px;"><b>${name}: ${icon} ${transKo(res)} ${time ? '/ '+time : ''}</b><br><div style="margin-top:8px; padding-left:10px; color:#555;">의견: ${esc(comm || "-")}</div></div>`;
}

function toggleEdit(dbId) {
    const btn = document.getElementById("btnEditMain");
    if(btn.innerText !== "저장") {
        document.getElementById("view-title").disabled = false;
        document.getElementById("view-purpose").disabled = false;
        document.getElementById("view-plan").disabled = false;
        document.getElementById("view-cost").disabled = false;
        btn.innerText = "저장"; btn.classList.add("green");
    } else {
        const updates = {
            title: document.getElementById("view-title").value.trim(),
            purpose: document.getElementById("view-purpose").value.trim(),
            plan: document.getElementById("view-plan").value.trim(),
            cost: document.getElementById("view-cost").value.replace(/,/g, '')
        };
        db.ref("approvals/"+dbId).update(updates).then(() => { 
            const msg = `[똑똑! 가족 게시판]\n아이의 의견이 수정되었습니다!`;
            const m = document.getElementById("pwModal");
            m.style.display = "flex";
            m.innerHTML = `<div class="card" style="text-align:center;">
                <b style="font-size:18px; display:block; margin-bottom:10px;">✅ 수정 완료</b>
                <p style="color:#666; margin-bottom:20px;">수정 사실을 가족들에게 알릴까요?</p>
                <div class="btn-row">
                  <a class="sms-btn" href="${getSmsUrl(msg)}" onclick="document.getElementById('pwModal').style.display='none'; render();">문자 보내기</a>
                  <button class="gray" onclick="document.getElementById('pwModal').style.display='none'; render();">그냥 닫기</button>
                </div>
              </div>`;
        });
    }
}

function askDelete(dbId){
  const m = document.getElementById("pwModal"); m.style.display="flex";
  m.innerHTML=`<div class="card" style="text-align:center;"><b>기록 삭제</b><input id="delPw" type="password" placeholder="비밀번호"><div class="btn-row"><button class="fit" onclick="authDelete('${dbId}')">확인</button><button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">닫기</button></div></div>`;
}
function authDelete(dbId){ if(document.getElementById("delPw").value === PASSWORD){ db.ref("approvals/"+dbId).remove().then(() => { navigate({page:'list'}); document.getElementById("pwModal").style.display="none"; }); } else { alert("비밀번호가 틀렸습니다."); } }

function openParent(id){
  const m = document.getElementById("pwModal"); m.style.display="flex";
  m.innerHTML=`<div class="card" style="text-align:center;"><b>부모 인증</b><input id="pw" type="password" placeholder="비밀번호"><div class="btn-row"><button class="fit" onclick="authParent('${id}')">확인</button><button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">닫기</button></div></div>`;
}

function authParent(id){
  if(document.getElementById("pw").value!==PASSWORD) return alert("틀렸습니다.");
  document.getElementById("pwModal").style.display="none";
  const r = allData.find(x=>String(x.id)===String(id)); 
  
  // 수정 사항 2: 입력 페이지 진입 시 기존 로그 숨김
  const logArea = document.getElementById("parentViewLog");
  if(logArea) logArea.style.display = "none";

  let h = "";
  const momVal = r.momC || tempParentInput.momC;
  const dadVal = r.dadC || tempParentInput.dadC;
  
  const isMomEdit = r.mom && r.mom !== 'pending';
  const isDadEdit = r.dad && r.dad !== 'pending';

  // 수정 사항 2: 입력칸 위에 기존 기록 요약 표시
  const momIcon = r.mom === 'approve' ? '✅ 찬성' : (r.mom === 'reject' ? '❌ 반대' : '⏳ 대기');
  const dadIcon = r.dad === 'approve' ? '✅ 찬성' : (r.dad === 'reject' ? '❌ 반대' : '⏳ 대기');

  h += `<div class="card">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px;">
            <b>엄마 의견</b>
            <span style="color:#666;">${momIcon} ${r.momTime ? '('+r.momTime+')' : ''}</span>
          </div>
          <textarea id="momC" rows="3" oninput="tempParentInput.momC=this.value">${momVal}</textarea>
          <div style="text-align:left; margin-top:10px;">
            <button class="fit green" onclick="confirmDecide('${r.dbId}','mom','approve','${r.title}', '${r.cost}', ${isMomEdit})">찬성</button>
            <button class="fit red" onclick="confirmDecide('${r.dbId}','mom','reject','${r.title}', '${r.cost}', ${isMomEdit})">반대</button>
          </div>
        </div>`;
        
  h += `<div class="card">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px;">
            <b>아빠 의견</b>
            <span style="color:#666;">${dadIcon} ${r.dadTime ? '('+r.dadTime+')' : ''}</span>
          </div>
          <textarea id="dadC" rows="3" oninput="tempParentInput.dadC=this.value">${dadVal}</textarea>
          <div style="text-align:left; margin-top:10px;">
            <button class="fit green" onclick="confirmDecide('${r.dbId}','dad','approve','${r.title}', '${r.cost}', ${isDadEdit})">찬성</button>
            <button class="fit red" onclick="confirmDecide('${r.dbId}','dad','reject','${r.title}', '${r.cost}', ${isDadEdit})">반대</button>
          </div>
        </div>`;
  
  document.getElementById("parentArea").innerHTML = h;
  document.getElementById("parentBtnWrapper").style.display = "none";
}

function confirmDecide(dbId, who, val, title, cost, isEdit = false) {
    const comment = document.getElementById(who + "C").value.trim();
    if (!comment) return alert("의견을 반드시 입력해야 합니다.");
    const m = document.getElementById("pwModal"); m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>의견 등록 확인</b><p style="margin-top:10px;">의견을 ${isEdit ? '수정' : '등록'}하시겠습니까?</p><div class="btn-row"><button class="fit" onclick="decide('${dbId}','${who}','${val}','${title}', '${cost}', ${isEdit})">확인</button><button class="fit gray" onclick="document.getElementById('pwModal').style.display='none'">취소</button></div></div>`;
}

function decide(dbId, who, val, title, cost, isEdit = false){
    const comment = document.getElementById(who+"C").value;
    if(who === 'mom') tempParentInput.momC = ""; else tempParentInput.dadC = "";
    db.ref("approvals/"+dbId).update({ [who]: val, [who+"C"]: comment, [who+"Time"]: now() }).then(() => {
        const whoKo = (who === 'mom' ? '엄마' : '아빠');
        const msg = isEdit ? `[똑똑! 가족 게시판]\n${whoKo}의 의견이 수정되었습니다!` : `[똑똑! 가족 게시판]\n${whoKo}의 의견이 등록되었습니다`;
        const m = document.getElementById("pwModal"); m.style.display = "flex";
        m.innerHTML = `<div class="card" style="text-align:center;"><b style="font-size:18px; display:block; margin-bottom:10px;">✅ 처리 완료</b><p style="color:#666; margin-bottom:20px;">가족들에게 문자로 알릴까요?</p><div class="btn-row"><a class="sms-btn" href="${getSmsUrl(msg)}" onclick="document.getElementById('pwModal').style.display='none'; navigate({page:'list'});">문자 보내기</a><button class="gray" onclick="document.getElementById('pwModal').style.display='none'; navigate({page:'list'});">그냥 닫기</button></div></div>`;
    });
}

function doSearch(){ keyword = document.getElementById("q").value.trim(); render(); }
function openStats(){
  const stats = {}; allData.filter(x => getStatus(x) !== "대기").forEach(item => { const key = item.time.substring(0,7).replace("-","년 ") + "월"; if(!stats[key]) stats[key] = {app:0, appS:0, rej:0, rejS:0}; const s = getStatus(item), c = Number(item.cost); if(s==="찬성"){ stats[key].app++; stats[key].appS+=c; } else { stats[key].rej++; stats[key].rejS+=c; } });
  const sorted = Object.keys(stats).sort().reverse(), m = document.getElementById("statModal"); m.style.display="flex";
  m.innerHTML = `<div class="card"><h3>월간 통계</h3><div class="table-wrapper">${sorted.map(k=>`<div class="stat-item"><b>${k}</b><br>✅ 찬성: ${stats[k].app}건 (${stats[k].appS.toLocaleString()}원) <br>❌ 반대: ${stats[k].rej}건 (${stats[k].rejS.toLocaleString()}원)</div>`).join("")}</div><button onclick="document.getElementById('statModal').style.display='none'">닫기</button></div>`;
}

window.onpopstate = (e) => { 
  if(e.state) { route = e.state; render(); } 
  else { window.history.back(); } 
};
history.replaceState({page:'list'}, "");
</script>
</body>
</html>
