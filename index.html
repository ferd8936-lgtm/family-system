<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>가족 결재시스템</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js" crossorigin="anonymous"></script>

<style>
:root{--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--brand:#6366f1;--ok:#16a34a;--bad:#dc2626;--wait:#d97706;}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;background:var(--bg);}
header{padding:16px;text-align:center;font-size:20px;font-weight:700;background:#fff;border-bottom:1px solid var(--line);}
main{max-width:1100px;margin:auto;padding:16px;}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;}
button{padding:12px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin:6px 0;width:100%;}
button.gray{background:#e5e7eb;color:#111}
button.green{background:var(--ok)}
button.red{background:var(--bad)}
input, textarea {width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);margin-top:6px;font-size:16px;font-family:inherit;}
label{font-weight:600;margin-top:14px;display:block;}
.badge{padding:6px 10px;border-radius:6px;color:#fff;font-size:13px;font-weight:700;}
.ok{background:var(--ok)}.no{background:var(--bad)}.wait{background:var(--wait)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index: 1000;}
.modal .card{width:min(480px,100%); max-height: 85vh; overflow-y: auto;}
.table-wrapper {max-height: 540px;overflow-y: auto;border: 1px solid var(--line);border-radius: 8px;}
table{width:100%; border-collapse:collapse;}
th,td{padding:12px;border-bottom:1px solid var(--line);text-align:center;}
</style>
</head>
<body>
<header>가족 결재시스템</header>
<main id="app">데이터 로딩 중...</main>
<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
/* 1. 설정 및 초기화 */
const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const PASSWORD = "7102";

try {
    if (!Kakao.isInitialized()) {
        Kakao.init('26e990028f2acdd8db09ffa1c4e10c17'); //
    }
} catch(e) {}

let route = { page: "list", id: null };
let keyword = "";
let allData = [];

db.ref("approvals").on("value", (snapshot) => {
  const val = snapshot.val();
  allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
  render();
});

/* 2. 카카오톡 공유 기능 (강화 버전) */
function shareKakao(text) {
  const link = "https://ferd8936-lgtm.github.io/family-system/"; //
  if (Kakao.isInitialized()) {
      Kakao.Share.sendDefault({
          objectType: 'feed',
          content: {
              title: '가족 결재 알림',
              description: text,
              imageUrl: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
              link: { mobileWebUrl: link, webUrl: link }
          },
          buttons: [{ title: '결재 확인하기', link: { mobileWebUrl: link, webUrl: link } }]
      });
  } else {
      window.location.href = `kakaolink://send?text=${encodeURIComponent(text + "\n" + link)}`;
  }
}

/* 3. 유틸리티 함수 */
function now(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }
function formatComma(v){ return v.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function getStatus(r){
  const mom = r.mom || "pending"; const dad = r.dad || "pending";
  if(mom === "pending" || dad === "pending") return "대기";
  return (mom === "approve" && dad === "approve") ? "승인" : "반려";
}
function badge(s){ return `<span class="badge ${s==='승인'?'ok':(s==='반려'?'no':'wait')}">${s}</span>`; }
function navigate(p){ route = p; render(); }

/* 4. 화면 렌더링 */
function render(){
  const app = document.getElementById("app");
  let displayData = [...allData].sort((a,b) => b.time.localeCompare(a.time));
  if(keyword) displayData = displayData.filter(x => JSON.stringify(x).includes(keyword));

  if(route.page === "list"){
    app.innerHTML = `
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <input id="q" placeholder="검색어" value="${esc(keyword)}" style="margin:0;">
        <button onclick="keyword=document.getElementById('q').value; render();" class="gray" style="width:80px; margin:0;">검색</button>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:16px;">
        <button onclick="navigate({page:'new'})">결재 올리기</button>
        <button class="gray" onclick="openStats()">월간 통계</button>
      </div>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>제목</th><th>상태</th></tr></thead>
          <tbody>
            ${displayData.map(r=>`
              <tr onclick="navigate({page:'view', id:'${r.id}'})">
                <td style="text-align:left;">${esc(r.title)}<br><small>${r.time}</small></td>
                <td>${badge(getStatus(r))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
  } 
  else if(route.page === "new"){
    app.innerHTML = `<div class="card">
      <label>제목</label><input id="t" placeholder="무엇이 필요한가요?">
      <label>비용(원)</label><input id="c" oninput="this.value=formatComma(this.value)">
      <label>상세 내용</label><textarea id="p" rows="5"></textarea>
      <button onclick="submit()">결재 상신</button>
      <button class="gray" onclick="navigate({page:'list'})">취소</button>
    </div>`;
  } 
  else if(route.page === "view"){
    const r = allData.find(x => x.id === route.id);
    app.innerHTML = `<div class="card">
      <h3>${esc(r.title)}</h3>
      <p><b>비용:</b> ${Number(r.cost).toLocaleString()}원</p>
      <p><b>내용:</b><br>${esc(r.purpose)}</p>
      <div style="background:#f9fafb; padding:10px; border-radius:8px; margin:15px 0;">
        엄마: ${r.mom==='approve'?'승인':(r.mom==='reject'?'반려':'대기')} / 
        아빠: ${r.dad==='approve'?'승인':(r.dad==='reject'?'반려':'대기')}
      </div>
      <button class="green" onclick="openParent('${r.id}')">부모 결재</button>
      <button class="gray" onclick="navigate({page:'list'})">목록으로</button>
      <button class="red" style="margin-top:20px;" onclick="askDelete('${r.dbId}')">결재 삭제</button>
    </div>`;
  }
}

/* 5. 주요 기능 로직 */
function submit(){
  const t=document.getElementById("t").value;
  const c=document.getElementById("c").value.replace(/,/g,'');
  const p=document.getElementById("p").value;
  if(!t||!c||!p) return alert("내용을 모두 입력해주세요.");
  const newPost = { id:Date.now().toString(), title:t, cost:c, purpose:p, time:now(), mom:"pending", dad:"pending" };
  db.ref("approvals").push(newPost).then(()=>{
    shareKakao(`[결재요청] ${t}\n금액: ${Number(c).toLocaleString()}원\n승인 부탁드립니다!`);
    navigate({page:'list'});
  });
}

function openParent(id){
  const pw = prompt("비밀번호를 입력하세요.");
  if(pw !== PASSWORD) return alert("비밀번호가 틀렸습니다.");
  const who = prompt("누구신가요? (엄마 / 아빠)");
  const key = who === "엄마" ? "mom" : (who === "아빠" ? "dad" : null);
  if(!key) return alert("엄마 또는 아빠라고 입력해주세요.");
  const val = confirm("승인하시겠습니까? (취소 누르면 반려 처리)") ? "approve" : "reject";
  const r = allData.find(x=>x.id===id);
  const up = {}; up[key] = val;
  db.ref("approvals/"+r.dbId).update(up).then(()=>{
    shareKakao(`[결재결과] ${r.title}\n${who}님이 ${val==='approve'?'승인':'반려'}하셨습니다.`);
    navigate({page:'list'});
  });
}

function askDelete(dbId){
  if(prompt("삭제하시려면 비밀번호를 입력하세요.") === PASSWORD){
    db.ref("approvals/"+dbId).remove().then(() => { alert("삭제되었습니다."); navigate({page:'list'}); });
  }
}

function openStats(){
  const stats = {};
  allData.forEach(r => {
    const month = r.time.substring(0,7);
    if(!stats[month]) stats[month] = {total:0, count:0};
    if(getStatus(r)==="승인"){ stats[month].total += Number(r.cost); stats[month].count++; }
  });
  alert(Object.keys(stats).map(m => `[${m}] 승인: ${stats[m].count}건 / 합계: ${stats[m].total.toLocaleString()}원`).join("\n") || "데이터가 없습니다.");
}

render();
</script>
</body>
</html>
